import { useState } from "react";
import { useSelector, useDispatch } from "react-redux";
import { useNavigate } from "react-router-dom";
import { __getComments } from "../../modules/commentsSlice";
import { __AddLikes, __getPosts } from "../../modules/postsSlice";
import {
  __signUp,
  __getUsers,
  __switchIsLogin,
  __userLikes,
} from "../../modules/usersSlice";
import {
  Article,
  H1,
  PostBox,
  PostLike,
  Section,
  PostContainer,
  GageBar,
  BarA,
} from "./style";

const PostList = () => {
  const dispatch = useDispatch();
  const { error, posts } = useSelector((state) => state.posts);
  const { comments } = useSelector((state) => state.comments);
  const { users } = useSelector((state) => state.users);

  const currentUserId = localStorage.getItem("id");
  const myLikes = users.filter((user) => user.id == currentUserId);

  const navigate = useNavigate();
  if (error) {
    return <div>{error.message}</div>;
  }

  // Ï¢ãÏïÑÏöî Ï∂îÍ∞Ä Ìï®Ïàò
  const switchLikesHandler = (post) => {
    //filter ,find Ìï®ÏàòÎ•º ÏÇ¨Ïö©ÌïòÏó¨ likeÌÇ§Í∞íÏóê Ìï¥Îãπ Í∞íÏù¥ ÏûàÎäî ÌåêÎ≥Ñ
    const isNotLike = post.like.filter((like) => like !== currentUserId);
    const isLike = post.like.find((like) => like === currentUserId);

    const addLike = {
      ...post,
      like: [...post.like, currentUserId],
    };
    const deleteLike = {
      ...post,
      like: isNotLike,
    };
    //  Í±∞ÏßìÏù¥Î©¥ Ï∂îÍ∞Ä Ï∞∏Ïù¥Î©¥ ÏÇ≠Ï†ú
    if (isLike !== currentUserId) {
      dispatch(__AddLikes(addLike));
    }
    if (isLike === currentUserId) {
      dispatch(__AddLikes(deleteLike));
    }
    console.log(post.like);
  };

  return (
    <Section>
      <H1>ÌÜ†Î°†Ï£ºÏ†ú</H1>

      {posts.map((post) => {
        let countA = 0;
        let countB = 0;
        let barA = "lightgray";
        let barB = "gray";
        comments.map((comment) => {
          if (comment.isA === true && comment.postId === post.id) {
            countA = countA + 1;
            barA = "coral";
          }
          if (comment.isA === false && comment.postId === post.id) {
            countB = countB + 1;
            barB = "skyblue";
          }
        });
        let ratioA = Math.round(100 - (countA / (countA + countB)) * 100);
        let ratioB = Math.round(100 - (countB / (countA + countB)) * 100);

        if (countA === 0) {
          ratioA = 50;
        }
        if (countB === 0) {
          ratioB = 50;
        }
        return (
          <Article
            key={post.id}
            // onClick={() => {
            //   navigate(`/${post.id}`);
            // }}
          >
            <PostContainer>
              <PostBox>
                <div>ÎÖºÏ†ú: {post.title}</div>
                <div>
                  <div>
                    A: {post.categoryA} vs B: {post.categoryB}
                  </div>
                  <div></div>
                </div>
              </PostBox>
              <PostLike onClick={() => switchLikesHandler(post)}>
                üëç
                <br />({post.like.length})
              </PostLike>
            </PostContainer>
            <GageBar>
              <BarA bg={ratioA} color={barA}>
                {ratioA}%
              </BarA>
              <BarA bg={ratioB} color={barB}>
                {ratioB}%
              </BarA>
            </GageBar>
          </Article>
        );
      })}
    </Section>
  );
};
export default PostList;
